# 无主账号功能

## 功能概述

在联盟成员批量导入功能中，如果导入的账号在系统中不存在，系统会自动创建一个"无主账号"（不属于任何用户但属于联盟的账号）。当用户后续加入联盟时，如果联盟中存在与用户账号同名的无主账号，系统会自动将该无主账号归属给用户。

## 主要特性

### 1. 批量导入时创建无主账号

- **触发条件**: 在 `/api/alliance-members/alliances/{allianceId}/bulk-update-from-text` 接口中，如果导入的账号名称在联盟中不存在
- **创建逻辑**: 
  - 创建一个 `userId` 为 `null` 的 GameAccount
  - 设置账号的 `allianceId` 为当前联盟ID
  - 根据导入数据设置账号的阶级（memberTier）和战力（powerValue）
  - 设置账号的服务器ID与联盟相同

### 2. 用户加入联盟时的账号归属

- **触发条件**: 用户通过 `applyToJoinAlliance` 或 `processApplication` 加入联盟时
- **检查逻辑**: 系统会检查联盟中是否存在与用户账号同名且 `userId` 为 `null` 的无主账号
- **归属逻辑**: 
  - 如果找到同名无主账号，删除用户原有账号
  - 将无主账号的 `userId` 设置为当前用户ID
  - 用户直接获得无主账号的所有属性（阶级、战力等）

## 数据库变更

### GameAccount 实体变更

```java
// 修改前
@Column(name = "user_id", nullable = false)
private Long userId;

// 修改后
@Column(name = "user_id", nullable = true)
private Long userId;
```

### 新增查询方法

```java
// GameAccountRepository 中新增
List<GameAccount> findByAllianceIdAndUserIdIsNull(Long allianceId);
```

## API 响应变更

### 批量更新接口响应

```json
{
  "code": 200,
  "message": "批量更新完成",
  "data": "已更新成员数: 5，已创建无主账号数: 3。\n"
}
```

## 使用场景

1. **联盟管理员导入成员名单**: 管理员可以导入完整的成员名单，即使某些成员尚未注册系统
2. **新用户无缝加入**: 新用户注册并加入联盟时，可以直接获得已有的账号数据（阶级、战力等）
3. **数据一致性**: 确保联盟成员数据的完整性和一致性

## 安全考虑

1. **权限控制**: 只有联盟盟主可以执行批量导入操作
2. **数据验证**: 创建无主账号时会验证联盟存在性和数据格式
3. **账号归属**: 只有账号名称完全匹配时才会进行归属操作

## 测试覆盖

- ✅ 批量导入时创建无主账号
- ✅ 用户加入联盟时账号自动归属
- ✅ 正常加入联盟流程（无同名无主账号）
- ✅ 权限验证和错误处理

## 注意事项

1. 无主账号的 `userId` 字段为 `null`，在相关业务逻辑中需要进行空值检查
2. 账号归属是不可逆操作，一旦归属给用户就无法撤销
3. 账号名称匹配是精确匹配，区分大小写